name: Deploy to Azure Container App service
on: 
  workflow_run:
    workflows:
      - Build and push images to DockerHub
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure CLI script
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account show

      - name: Extract environment from tag
        id: extract_env
        run: |
          TAG_NAME="${{ github.ref_name }}"
          ENV_NAME="${TAG_NAME##*-}"
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT

      - name: Setting up env vars
        run: |
           echo "DEPLOYMENT_NAME=over-eng-backend-${{ steps.extract_env.outputs.env_name }}" >> $GITHUB_ENV
           echo "IMAGE_TAG=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Deploy to container app
        run: | 
            az containerapp create \
              --name $DEPLOYMENT_NAME \
              --resource-group $AZURE_RESOURCE_GROUP \
              --environment $AZURE_CONTAINER_ENV \
              --image $DOCKER_REPO_NAME:$IMAGE_TAG \
              --ingress external \
              --target-port $TARGET_PORT \
              --registry-server docker.io \
              --registry-username $DOCKERHUB_USERNAME \
              --registry-password ${{ secrets.DOCKERHUB_TOKEN }} \
              --cpu 0.5 \
              --memory 1.0Gi
